<!DOCTYPE HTML>
<html>
<head>
	<script type="text/javascript">
		// Toolbar item click
		function onCommand (event) {
			var pageProxy = safari.application.activeBrowserWindow.activeTab.page;
			if (event.command === 'Cache Inspector') {
				pageProxy.dispatchMessage('toggleManifestInspector');
			}
		}
		// Toolbar item disable loop
		function onValidate (event) {
			var pageProxy = safari.application.activeBrowserWindow.activeTab.page;
			if (event.command === 'Cache Inspector') {
				if(!event.target.browserWindow.activeTab.url) {
					event.target.disabled = true;
					event.target.badge = null;
				}
				if(pageProxy) pageProxy.dispatchMessage('updateToolbarItem');
			}
		}
		
		// Proxy messages from injected scripts.
		function onMessage (event) {
			switch(event.name) {
				case 'updateToolbarItem':
					updateToolbarItem(event);
					break;
			}
		}
		
		function updateToolbarItem (event) {
			// Ignore updates from non-active tabs.
			if(event.target !== event.target.browserWindow.activeTab) return;
			
			var toolbarItem, tooltip;
			if(event.name === 'updateToolbarItem') {
				for(var k in safari.extension.toolbarItems) {
					// Find the window for this event and update its toolbar item.
					toolbarItem = safari.extension.toolbarItems[k];
					toolbarItem.disabled = (event.message.status === 0 || event.message.status === null);
					if(toolbarItem.browserWindow === event.target.browserWindow) {
						toolbarItem.badge = event.message.status;
						// toolbarItem.toolTip = event.target.browserWindow.activeTab.url;
						toolTip = 'Status: ' + cacheStatusToString(event.message.status);
						if(event.message.manifest) toolTip = toolTip + '\nManifest: ' + event.message.manifest;
						toolbarItem.toolTip = toolTip;
					} else {
						toolbarItem.badge = null;
						toolbarItem.toolTip = '';
					}
				}
			}
		}
		function cacheStatusToString (status) {
			switch(status) {
				case 0:
					return 'UNCACHED';
				case 1:
					return 'IDLE';
				case 2:
					return 'CHECKING';
				case 3:
					return 'DOWNLOADING';
				case 4:
					return 'UPDATEREADY';
			}
			// else
			return '';
		}
		
		// if event handlers are in the global HTML page,
		// register with application:
		safari.application.addEventListener('command', onCommand, false);
		safari.application.addEventListener('validate', onValidate, false);
		safari.application.addEventListener('message', onMessage, false);
	</script>
</head>
</html>